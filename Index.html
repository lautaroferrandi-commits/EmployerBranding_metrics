<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Video Metrics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- DM Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #ff355e;
      --bg: #f7f7f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 1px 2px rgba(0,0,0,.04);
      --chip: rgba(255, 53, 94, 0.10);
      --chipText: #b10a2c;
      --focus: rgba(255, 53, 94, 0.25);
      --good: #16a34a;
      --danger: #dc2626;
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    header h1 { margin: 0; font-size: 18px; }

    nav { display: flex; align-items: center; gap: 10px; }

    nav button {
      background: none;
      border: none;
      font-weight: 800;
      cursor: pointer;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 10px;
    }

    nav button:hover { background: #f3f4f6; }
    nav button.active { color: var(--primary); background: rgba(255,53,94,0.06); }

    main { padding: 20px; max-width: 1200px; margin: 0 auto; }

    .page { display: none; }
    .page.active { display: block; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .card .k {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: .04em;
    }

    .card .v {
      font-size: 26px;
      font-weight: 900;
      margin-top: 2px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .chart-area {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      height: 340px;
      box-shadow: var(--shadow);
    }

    .chart-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 12px;
    }

    .chart-title h3 { margin: 0; font-size: 14px; font-weight: 900; }

    .mini-select {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 800;
      font-family: inherit;
      background: white;
      cursor: pointer;
      outline: none;
    }
    .mini-select:focus { box-shadow: 0 0 0 4px var(--focus); border-color: var(--primary); }

    .ranking {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-top: 20px;
      box-shadow: var(--shadow);
    }

    .ranking-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .ranking-head h3 { margin: 0; font-size: 14px; font-weight: 900; }

    .rank-item {
      display: grid;
      grid-template-columns: 30px 1fr auto;
      gap: 12px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .rank-item:first-child { border-top: none; }

    .rank-num {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: var(--chip);
      color: var(--primary);
      display: grid;
      place-items: center;
      font-weight: 900;
    }

    .rank-title { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
    .rank-title strong { font-weight: 900; }
    .rank-sub { color: var(--muted); font-size: 12px; font-weight: 700; }

    .rank-bar {
      height: 7px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }

    .rank-bar > div {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 220ms ease;
    }

    .rank-breakdown {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }
    .chip {
      background: #f9fafb;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 11px;
      line-height: 1.1;
    }
    .chip .label { color: var(--muted); font-weight: 800; text-transform: uppercase; letter-spacing: .03em; }
    .chip .value { font-weight: 900; margin-top: 2px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: .04em;
    }

    td.wrap { white-space: normal; }

    .muted { color: var(--muted); }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      border: 1px solid var(--border);
      background: white;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 900;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
    }
    .btn:hover { background: #f9fafb; }
    .btn:focus { outline: none; box-shadow: 0 0 0 4px var(--focus); border-color: var(--primary); }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .btn-primary:hover { filter: brightness(0.98); }

    .btn-danger {
      border-color: rgba(220,38,38,.25);
      color: var(--danger);
      background: rgba(220,38,38,.04);
    }
    .btn-danger:hover { background: rgba(220,38,38,.08); }

    .empty {
      padding: 16px;
      color: var(--muted);
      font-weight: 800;
      text-align: center;
    }

    form {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      max-width: 720px;
      box-shadow: var(--shadow);
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-row.one { grid-template-columns: 1fr; }

    label {
      display: block;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    input {
      width: 100%;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font: inherit;
      outline: none;
      background: white;
    }
    input:focus { box-shadow: 0 0 0 4px var(--focus); border-color: var(--primary); }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0 2px;
    }
    .checkbox input { width: auto; }

    .form-actions { display: flex; gap: 10px; margin-top: 10px; }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      font-weight: 700;
    }

    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
      th, td { white-space: normal; }
      .rank-breakdown { grid-template-columns: 1fr 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header>
  <h1>Video Analytics</h1>
  <nav>
    <button class="active" data-page="dashboard" type="button">Dashboard</button>
    <button data-page="form" type="button">Add / Edit</button>
  </nav>
</header>

<main>
  <section id="dashboard" class="page active">

    <div class="cards">
      <div class="card"><div class="k">Videos</div><div class="v" id="totalVideos">0</div></div>
      <div class="card"><div class="k">Views</div><div class="v" id="totalViews">0</div></div>
      <div class="card"><div class="k">Likes</div><div class="v" id="totalLikes">0</div></div>
      <div class="card"><div class="k">Comments</div><div class="v" id="totalComments">0</div></div>
      <div class="card"><div class="k">Reposts</div><div class="v" id="totalReposts">0</div></div>
      <div class="card"><div class="k">Conversions</div><div class="v" id="totalConversions">0</div></div>
    </div>

    <div class="grid-2">
      <div class="chart-area">
        <div class="chart-title">
          <h3 id="metricByVideoTitle">Views by Video</h3>
          <select id="metricSelect" class="mini-select">
            <option value="views">Views</option>
            <option value="likes">Likes</option>
            <option value="comments">Comments</option>
            <option value="reposts">Reposts</option>
            <option value="conversions">Conversions</option>
          </select>
        </div>
        <canvas id="metricChart"></canvas>
      </div>

      <div class="chart-area">
        <div class="chart-title">
          <h3 id="metricOverTimeTitle">Views over Time</h3>
        </div>
        <canvas id="metricTimeChart"></canvas>
      </div>
    </div>

    <div class="ranking">
      <div class="ranking-head">
        <h3>Top Performing Videos</h3>
        <select id="rankSort" class="mini-select" title="Ordenar ranking">
          <option value="score">Score (compuesto)</option>
          <option value="views">Views</option>
          <option value="likes">Likes</option>
          <option value="comments">Comments</option>
          <option value="reposts">Reposts</option>
          <option value="conversions">Conversions</option>
        </select>
      </div>
      <div id="rankingList"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Video</th>
          <th>Channel</th>
          <th>Date</th>
          <th>Views</th>
          <th>Likes</th>
          <th>Comments</th>
          <th>Reposts</th>
          <th>UTM</th>
          <th>Conversions</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="videoTable"></tbody>
    </table>
  </section>

  <section id="form" class="page">
    <form id="videoForm">
      <input type="hidden" id="videoId" />

      <div class="form-row one">
        <div>
          <label for="title">Video title</label>
          <input id="title" placeholder="Ej: Black Friday Teaser" required />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="channel">Channel</label>
          <input id="channel" placeholder="Ej: TikTok / IG / YouTube" />
        </div>
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" required />
        </div>
      </div>

      <div class="checkbox">
        <input type="checkbox" id="hasUtm" />
        <label for="hasUtm" style="margin:0; text-transform:none; letter-spacing:0; font-weight:900; color:var(--text);">
          Has UTM link
        </label>
      </div>

      <div class="form-row one" id="conversionsRow" style="display:none;">
        <div>
          <label for="conversions">Conversions (manual)</label>
          <input type="number" id="conversions" placeholder="0" min="0" step="1" />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="views">Views</label>
          <input type="number" id="views" placeholder="0" min="0" step="1" />
        </div>
        <div>
          <label for="likes">Likes</label>
          <input type="number" id="likes" placeholder="0" min="0" step="1" />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="comments">Comments</label>
          <input type="number" id="comments" placeholder="0" min="0" step="1" />
        </div>
        <div>
          <label for="reposts">Reposts</label>
          <input type="number" id="reposts" placeholder="0" min="0" step="1" />
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" id="saveBtn" type="submit">Save</button>
        <button class="btn" id="cancelEditBtn" type="button" style="display:none;">Cancel edit</button>
      </div>

      <div class="hint">
        Nota: Conversions son a nivel video (asociadas al UTM), tal como pediste.
      </div>
    </form>
  </section>
</main>

<script>
  // -----------------------------
  // Utils
  // -----------------------------
  const nf = new Intl.NumberFormat('es-ES');
  const METRICS = ['views', 'likes', 'comments', 'reposts', 'conversions'];
  const METRIC_LABEL = {
    views: 'Views',
    likes: 'Likes',
    comments: 'Comments',
    reposts: 'Reposts',
    conversions: 'Conversions'
  };

  // Pesos del score compuesto (suman 1)
  const SCORE_WEIGHTS = {
    views: 0.40,
    likes: 0.20,
    comments: 0.15,
    reposts: 0.15,
    conversions: 0.10
  };

  function uid() {
    return 'v_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function clampNonNeg(n) {
    n = Number(n);
    return Number.isFinite(n) && n > 0 ? Math.floor(n) : 0;
  }

  function formatDateISO(iso) {
    if (!iso) return '—';
    // Evita shift por timezone
    const d = new Date(iso + 'T00:00:00');
    return new Intl.DateTimeFormat('es-ES', { year:'numeric', month:'2-digit', day:'2-digit' }).format(d);
  }

  function sumBy(videos, key) {
    return videos.reduce((a, v) => a + (Number(v[key]) || 0), 0);
  }

  function maxima(videos) {
    const max = { views: 0, likes: 0, comments: 0, reposts: 0, conversions: 0 };
    for (const v of videos) {
      for (const m of METRICS) max[m] = Math.max(max[m], Number(v[m]) || 0);
    }
    return max;
  }

  // Normaliza por máximo (0..1). Si max=0 => 0.
  function norm(value, max) {
    if (!max || max <= 0) return 0;
    return (value || 0) / max;
  }

  // Score compuesto normalizado
  function computeScore(video, max) {
    let score = 0;
    for (const m of METRICS) {
      score += norm(video[m] || 0, max[m]) * SCORE_WEIGHTS[m];
    }
    return score; // 0..1
  }

  // -----------------------------
  // State + Elements
  // -----------------------------
  const state = {
    videos: [],
    metric: 'views',
    rankSort: 'score',
    editingId: null
  };

  const el = {
    pages: {
      dashboard: document.getElementById('dashboard'),
      form: document.getElementById('form'),
    },
    navButtons: Array.from(document.querySelectorAll('nav button')),
    totals: {
      videos: document.getElementById('totalVideos'),
      views: document.getElementById('totalViews'),
      likes: document.getElementById('totalLikes'),
      comments: document.getElementById('totalComments'),
      reposts: document.getElementById('totalReposts'),
      conversions: document.getElementById('totalConversions')
    },
    metricSelect: document.getElementById('metricSelect'),
    metricByVideoTitle: document.getElementById('metricByVideoTitle'),
    metricOverTimeTitle: document.getElementById('metricOverTimeTitle'),
    rankSort: document.getElementById('rankSort'),
    rankingList: document.getElementById('rankingList'),
    table: document.getElementById('videoTable'),

    // Form
    form: document.getElementById('videoForm'),
    videoId: document.getElementById('videoId'),
    title: document.getElementById('title'),
    channel: document.getElementById('channel'),
    date: document.getElementById('date'),
    hasUtm: document.getElementById('hasUtm'),
    conversionsRow: document.getElementById('conversionsRow'),
    conversions: document.getElementById('conversions'),
    views: document.getElementById('views'),
    likes: document.getElementById('likes'),
    comments: document.getElementById('comments'),
    reposts: document.getElementById('reposts'),
    saveBtn: document.getElementById('saveBtn'),
    cancelEditBtn: document.getElementById('cancelEditBtn')
  };

  let chartMetric = null;
  let chartTime = null;

  // -----------------------------
  // Persistence
  // -----------------------------
  const STORAGE_KEY = 'video_analytics_v1';

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) state.videos = parsed;
    } catch (e) {
      console.warn('No se pudo leer localStorage:', e);
    }
  }

  function persist() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.videos));
    } catch (e) {
      console.warn('No se pudo guardar en localStorage:', e);
    }
  }

  // -----------------------------
  // Navigation
  // -----------------------------
  function showPage(pageId) {
    Object.values(el.pages).forEach(p => p.classList.remove('active'));
    el.pages[pageId].classList.add('active');

    el.navButtons.forEach(b => b.classList.remove('active'));
    el.navButtons.find(b => b.dataset.page === pageId)?.classList.add('active');
  }

  // -----------------------------
  // Form logic
  // -----------------------------
  function toggleUtmUI() {
    const enabled = el.hasUtm.checked;
    el.conversionsRow.style.display = enabled ? 'block' : 'none';
    if (!enabled) el.conversions.value = '0';
  }

  function resetForm() {
    state.editingId = null;
    el.form.reset();
    el.videoId.value = '';
    el.conversionsRow.style.display = 'none';
    el.saveBtn.textContent = 'Save';
    el.cancelEditBtn.style.display = 'none';
  }

  function startEdit(id) {
    const v = state.videos.find(x => x.id === id);
    if (!v) return;

    state.editingId = id;
    el.videoId.value = v.id;
    el.title.value = v.title || '';
    el.channel.value = v.channel || '';
    el.date.value = v.date || '';
    el.views.value = v.views ?? 0;
    el.likes.value = v.likes ?? 0;
    el.comments.value = v.comments ?? 0;
    el.reposts.value = v.reposts ?? 0;

    el.hasUtm.checked = !!v.hasUtm;
    el.conversions.value = v.conversions ?? 0;
    toggleUtmUI();

    el.saveBtn.textContent = 'Update';
    el.cancelEditBtn.style.display = 'inline-block';
    showPage('form');
  }

  function deleteVideo(id) {
    const v = state.videos.find(x => x.id === id);
    if (!v) return;

    const ok = confirm(`¿Borrar el video "${v.title}"?`);
    if (!ok) return;

    state.videos = state.videos.filter(x => x.id !== id);
    if (state.editingId === id) resetForm();
    persist();
    render();
  }

  function upsertFromForm(e) {
    e.preventDefault();

    const payload = {
      id: el.videoId.value || uid(),
      title: (el.title.value || '').trim(),
      channel: (el.channel.value || '').trim(),
      date: el.date.value,

      views: clampNonNeg(el.views.value),
      likes: clampNonNeg(el.likes.value),
      comments: clampNonNeg(el.comments.value),
      reposts: clampNonNeg(el.reposts.value),

      hasUtm: !!el.hasUtm.checked,
      conversions: el.hasUtm.checked ? clampNonNeg(el.conversions.value) : 0
    };

    if (!payload.title) {
      alert('El título es obligatorio.');
      return;
    }
    if (!payload.date) {
      alert('La fecha es obligatoria.');
      return;
    }

    const idx = state.videos.findIndex(v => v.id === payload.id);
    if (idx >= 0) {
      state.videos[idx] = payload;
    } else {
      state.videos.push(payload);
    }

    persist();
    resetForm();
    showPage('dashboard');
    render();
  }

  // -----------------------------
  // Rendering
  // -----------------------------
  function renderTotals() {
    el.totals.videos.textContent = nf.format(state.videos.length);
    el.totals.views.textContent = nf.format(sumBy(state.videos, 'views'));
    el.totals.likes.textContent = nf.format(sumBy(state.videos, 'likes'));
    el.totals.comments.textContent = nf.format(sumBy(state.videos, 'comments'));
    el.totals.reposts.textContent = nf.format(sumBy(state.videos, 'reposts'));
    el.totals.conversions.textContent = nf.format(sumBy(state.videos, 'conversions'));
  }

  function renderTable() {
    if (state.videos.length === 0) {
      el.table.innerHTML = `<tr><td class="empty" colspan="10">Aún no hay videos. Ve a “Add / Edit” para cargar el primero.</td></tr>`;
      return;
    }

    el.table.innerHTML = state.videos
      .slice()
      .sort((a, b) => (b.date || '').localeCompare(a.date || '')) // por fecha desc
      .map(v => `
        <tr>
          <td class="wrap"><strong>${escapeHtml(v.title)}</strong></td>
          <td class="wrap">${escapeHtml(v.channel || '—')}</td>
          <td>${formatDateISO(v.date)}</td>
          <td>${nf.format(v.views || 0)}</td>
          <td>${nf.format(v.likes || 0)}</td>
          <td>${nf.format(v.comments || 0)}</td>
          <td>${nf.format(v.reposts || 0)}</td>
          <td>${v.hasUtm ? 'UTM' : '—'}</td>
          <td>${nf.format(v.conversions || 0)}</td>
          <td>
            <div class="actions">
              <button class="btn" type="button" data-edit="${v.id}">Edit</button>
              <button class="btn btn-danger" type="button" data-del="${v.id}">Delete</button>
            </div>
          </td>
        </tr>
      `)
      .join('');

    // Bind actions
    el.table.querySelectorAll('[data-edit]').forEach(btn => {
      btn.addEventListener('click', () => startEdit(btn.dataset.edit));
    });
    el.table.querySelectorAll('[data-del]').forEach(btn => {
      btn.addEventListener('click', () => deleteVideo(btn.dataset.del));
    });
  }

  function renderRanking() {
    if (state.videos.length === 0) {
      el.rankingList.innerHTML = `<div class="empty">Cargar videos para ver el ranking.</div>`;
      return;
    }

    const max = maxima(state.videos);

    // calcula score normalizado 0..1
    const scored = state.videos.map(v => {
      const score = computeScore(v, max);
      return { v, score };
    });

    // Orden según selector
    let ordered;
    if (state.rankSort === 'score') {
      ordered = scored.slice().sort((a, b) => b.score - a.score);
    } else {
      const k = state.rankSort;
      ordered = scored.slice().sort((a, b) => (b.v[k] || 0) - (a.v[k] || 0));
    }

    const bestScore = ordered[0]?.score || 1;

    el.rankingList.innerHTML = ordered.slice(0, 5).map((r, i) => {
      const v = r.v;

      // Desglose normalizado (para explicar el score)
      const parts = METRICS.map(m => {
        const normalized = norm(v[m] || 0, max[m]);
        const contrib = normalized * SCORE_WEIGHTS[m];
        return { m, normalized, contrib, raw: v[m] || 0 };
      });

      const scorePct = bestScore ? (r.score / bestScore) * 100 : 0;

      return `
        <div class="rank-item">
          <div class="rank-num">${i + 1}</div>
          <div>
            <div class="rank-title">
              <strong>${escapeHtml(v.title)}</strong>
              <span class="rank-sub">${escapeHtml(v.channel || '—')} · ${formatDateISO(v.date)}</span>
            </div>

            <div class="rank-bar"><div style="width:${scorePct.toFixed(1)}%"></div></div>

            <div class="rank-breakdown">
              ${parts.map(p => `
                <div class="chip" title="Normalizado: ${(p.normalized*100).toFixed(0)}% · Peso: ${(SCORE_WEIGHTS[p.m]*100).toFixed(0)}%">
                  <div class="label">${METRIC_LABEL[p.m]}</div>
                  <div class="value">${nf.format(p.raw)}</div>
                </div>
              `).join('')}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;">${(r.score * 100).toFixed(1)}</div>
            <div class="muted" style="font-size:11px; font-weight:800;">score</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderCharts() {
    const metric = state.metric;
    const label = METRIC_LABEL[metric] || 'Metric';

    el.metricByVideoTitle.textContent = `${label} by Video`;
    el.metricOverTimeTitle.textContent = `${label} over Time`;

    // ---- Chart 1: Metric by video
    const videoLabels = state.videos.map(v => v.title);
    const videoData = state.videos.map(v => v[metric] || 0);

    // Mejora: si hay muchos videos, horizontal
    const horizontal = state.videos.length > 8;

    if (chartMetric) chartMetric.destroy();
    chartMetric = new Chart(document.getElementById('metricChart'), {
      type: 'bar',
      data: {
        labels: videoLabels.length ? videoLabels : ['—'],
        datasets: [{
          data: videoLabels.length ? videoData : [0],
          backgroundColor: '#ff355e',
          borderRadius: 8
        }]
      },
      options: {
        indexAxis: horizontal ? 'y' : 'x',
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `${label}: ${nf.format(ctx.parsed[horizontal ? 'x' : 'y'])}`
            }
          }
        },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } }
        }
      }
    });

    // ---- Chart 2: Metric over time (agregado por fecha)
    const byDate = new Map();
    for (const v of state.videos) {
      const d = v.date || '—';
      byDate.set(d, (byDate.get(d) || 0) + (Number(v[metric]) || 0));
    }
    const dates = Array.from(byDate.keys())
      .filter(d => d !== '—')
      .sort((a, b) => a.localeCompare(b)); // asc

    const timeLabels = dates.length ? dates.map(formatDateISO) : ['—'];
    const timeData = dates.length ? dates.map(d => byDate.get(d) || 0) : [0];

    if (chartTime) chartTime.destroy();
    chartTime = new Chart(document.getElementById('metricTimeChart'), {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: [{
          data: timeData,
          borderColor: '#ff355e',
          backgroundColor: 'rgba(255,53,94,0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: (ctx) => `${label}: ${nf.format(ctx.parsed.y)}` }
          }
        }
      }
    });
  }

  function render() {
    renderTotals();
    renderRanking();
    renderTable();
    renderCharts();
  }

  // -----------------------------
  // Security: escape HTML in table/ranking
  // -----------------------------
  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // -----------------------------
  // Event bindings
  // -----------------------------
  el.navButtons.forEach(btn => {
    btn.addEventListener('click', () => showPage(btn.dataset.page));
  });

  el.metricSelect.addEventListener('change', () => {
    state.metric = el.metricSelect.value;
    render();
  });

  el.rankSort.addEventListener('change', () => {
    state.rankSort = el.rankSort.value;
    renderRanking();
  });

  el.hasUtm.addEventListener('change', toggleUtmUI);

  el.form.addEventListener('submit', upsertFromForm);

  el.cancelEditBtn.addEventListener('click', () => {
    resetForm();
    showPage('dashboard');
  });

  // -----------------------------
  // Init
  // -----------------------------
  load();
  state.metric = el.metricSelect.value;
  state.rankSort = el.rankSort.value;
  render();
</script>
</body>
</html>
