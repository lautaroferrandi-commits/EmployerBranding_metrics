<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Video Metrics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- DM Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #ff355e;
      --bg: #f7f7f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 1px 2px rgba(0,0,0,.04);
      --chip: rgba(255, 53, 94, 0.10);
      --chipText: #b10a2c;
      --focus: rgba(255, 53, 94, 0.25);
      --good: #16a34a;
      --danger: #dc2626;
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    header h1 { margin: 0; font-size: 18px; }

    nav { display: flex; align-items: center; gap: 10px; }

    nav button {
      background: none;
      border: none;
      font-weight: 800;
      cursor: pointer;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 10px;
    }

    nav button:hover { background: #f3f4f6; }
    nav button.active { color: var(--primary); background: rgba(255,53,94,0.06); }

    main { padding: 20px; max-width: 1200px; margin: 0 auto; }

    .page { display: none; }
    .page.active { display: block; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .card .k {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: .04em;
    }

    .card .v {
      font-size: 26px;
      font-weight: 900;
      margin-top: 2px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .chart-area {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      height: 340px;
      box-shadow: var(--shadow);
    }

    .chart-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 12px;
    }

    .chart-title h3 { margin: 0; font-size: 14px; font-weight: 900; }

    .mini-select {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 800;
      font-family: inherit;
      background: white;
      cursor: pointer;
      outline: none;
    }
    .mini-select:focus { box-shadow: 0 0 0 4px var(--focus); border-color: var(--primary); }

    .ranking {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-top: 20px;
      box-shadow: var(--shadow);
    }

    .ranking-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .ranking-head h3 { margin: 0; font-size: 14px; font-weight: 900; }

    .rank-item {
      display: grid;
      grid-template-columns: 30px 1fr auto;
      gap: 12px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .rank-item:first-child { border-top: none; }

    .rank-num {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: var(--chip);
      color: var(--primary);
      display: grid;
      place-items: center;
      font-weight: 900;
    }

    .rank-title { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
    .rank-title strong { font-weight: 900; }
    .rank-sub { color: var(--muted); font-size: 12px; font-weight: 700; }

    .rank-bar {
      height: 7px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }

    .rank-bar > div {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 220ms ease;
    }

    .rank-breakdown {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }

    .chip {
      background: #f9fafb;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 11px;
      line-height: 1.1;
    }
    .chip .label { color: var(--muted); font-weight: 800; text-transform: uppercase; letter-spacing: .03em; }
    .chip .value { font-weight: 900; margin-top: 2px; }

    .platform-chips { display:flex; gap:6px; flex-wrap:wrap; }
    .platform-pill {
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,53,94,0.22);
      background: rgba(255,53,94,0.06);
      color: var(--chipText);
      font-size: 12px;
      font-weight: 900;
    }

    /* NUEVO: detalle por plataforma en tabla */
    .platform-list { display: grid; gap: 10px; }
    .platform-item { display:flex; flex-wrap:wrap; align-items:center; gap: 8px; }
    .platform-metrics { width:100%; font-size: 11px; font-weight: 800; color: var(--muted); margin-top: -2px; }
    .platform-link {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      font-weight: 900;
      color: var(--primary);
      text-decoration: none;
      border: 1px solid rgba(255,53,94,0.22);
      background: rgba(255,53,94,0.06);
      padding: 5px 8px;
      border-radius: 10px;
    }
    .platform-link:hover { filter: brightness(0.98); }
    .platform-link:focus { outline: none; box-shadow: 0 0 0 4px var(--focus); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: .04em;
    }

    td.wrap { white-space: normal; }

    .muted { color: var(--muted); }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      border: 1px solid var(--border);
      background: white;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 900;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
    }
    .btn:hover { background: #f9fafb; }
    .btn:focus { outline: none; box-shadow: 0 0 0 4px var(--focus); border-color: var(--primary); }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .btn-primary:hover { filter: brightness(0.98); }

    .btn-danger {
      border-color: rgba(220,38,38,.25);
      color: var(--danger);
      background: rgba(220,38,38,.04);
    }
    .btn-danger:hover { background: rgba(220,38,38,.08); }

    .empty {
      padding: 16px;
      color: var(--muted);
      font-weight: 800;
      text-align: center;
    }

    form {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      max-width: 860px;
      box-shadow: var(--shadow);
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-row.one { grid-template-columns: 1fr; }

    label {
      display: block;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    input, select {
      width: 100%;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font: inherit;
      outline: none;
      background: white;
    }
    input:focus, select:focus { box-shadow: 0 0 0 4px var(--focus); border-color: var(--primary); }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0 2px;
    }
    .checkbox input { width: auto; }

    .form-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      font-weight: 700;
    }

    .platform-block {
      margin-top: 14px;
      border-top: 1px solid var(--border);
      padding-top: 14px;
    }

    .platform-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .platform-head h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 900;
    }

    .platform-row {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
    }

    .platform-row .row {
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .platform-row .row.two {
      grid-template-columns: 1fr 1fr;
    }

    .platform-row .row.one {
      grid-template-columns: 1fr;
    }

    .platform-row .row + .row { margin-top: 10px; }

    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
      th, td { white-space: normal; }
      .rank-breakdown { grid-template-columns: 1fr 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .platform-row .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header>
  <h1>Video Analytics</h1>
  <nav>
    <button class="active" data-page="dashboard" type="button">Dashboard</button>
    <button data-page="form" type="button">Add / Edit</button>
  </nav>
</header>

<main>
  <section id="dashboard" class="page active">

    <div class="cards">
      <div class="card"><div class="k">Videos</div><div class="v" id="totalVideos">0</div></div>
      <div class="card"><div class="k">Views</div><div class="v" id="totalViews">0</div></div>
      <div class="card"><div class="k">Likes</div><div class="v" id="totalLikes">0</div></div>
      <div class="card"><div class="k">Comments</div><div class="v" id="totalComments">0</div></div>
      <div class="card"><div class="k">Reposts</div><div class="v" id="totalReposts">0</div></div>
      <div class="card"><div class="k">Conversions</div><div class="v" id="totalConversions">0</div></div>
    </div>

    <div class="grid-2">
      <div class="chart-area">
        <div class="chart-title">
          <h3 id="metricByVideoTitle">Views by Video</h3>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <!-- NUEVO: filtro por plataforma -->
            <select id="platformFilter" class="mini-select" title="Filtrar por plataforma"></select>

            <select id="metricSelect" class="mini-select">
              <option value="views">Views</option>
              <option value="likes">Likes</option>
              <option value="comments">Comments</option>
              <option value="reposts">Reposts</option>
              <option value="conversions">Conversions</option>
            </select>
          </div>
        </div>
        <canvas id="metricChart"></canvas>
      </div>

      <div class="chart-area">
        <div class="chart-title">
          <h3 id="metricOverTimeTitle">Views over Time</h3>
        </div>
        <canvas id="metricTimeChart"></canvas>
      </div>
    </div>

    <div class="ranking">
      <div class="ranking-head">
        <h3>Top Performing Videos</h3>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <!-- NUEVO: filtro por plataforma (sincronizado con el de arriba) -->
          <select id="rankPlatformFilter" class="mini-select" title="Filtrar por plataforma"></select>

          <select id="rankSort" class="mini-select" title="Ordenar ranking">
            <option value="score">Score (compuesto)</option>
            <option value="views">Views</option>
            <option value="likes">Likes</option>
            <option value="comments">Comments</option>
            <option value="reposts">Reposts</option>
            <option value="conversions">Conversions</option>
          </select>
        </div>
      </div>
      <div id="rankingList"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Video</th>
          <th>Channel</th>
          <th>Date</th>
          <th>Platforms</th>
          <th>Views</th>
          <th>Likes</th>
          <th>Comments</th>
          <th>Reposts</th>
          <th>UTM</th>
          <th>Conversions</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="videoTable"></tbody>
    </table>
  </section>

  <section id="form" class="page">
    <form id="videoForm">
      <input type="hidden" id="videoId" />

      <div class="form-row one">
        <div>
          <label for="title">Video title</label>
          <input id="title" placeholder="Ej: Black Friday Teaser" required />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="channel">Channel</label>
          <input id="channel" placeholder="Ej: Factorial ES" />
        </div>
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" required />
        </div>
      </div>

      <div class="checkbox">
        <input type="checkbox" id="hasUtm" />
        <label for="hasUtm" style="margin:0; text-transform:none; letter-spacing:0; font-weight:900; color:var(--text);">
          Has UTM link
        </label>
      </div>

      <div class="form-row one" id="conversionsRow" style="display:none;">
        <div>
          <label for="conversions">Conversions (manual)</label>
          <input type="number" id="conversions" placeholder="0" min="0" step="1" />
        </div>
      </div>

      <div class="platform-block">
        <div class="platform-head">
          <h3>Platforms</h3>
          <button class="btn" id="addPlatformBtn" type="button">+ Add platform</button>
        </div>
        <div id="platformRows"></div>
        <div class="hint">Tip: Add one row per platform (Instagram, LinkedIn, YouTube, TikTok, Oktopost). Totals are aggregated across all platforms.</div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" id="saveBtn" type="submit">Save</button>
        <button class="btn" id="cancelEditBtn" type="button" style="display:none;">Cancel edit</button>
      </div>

      <div class="hint">
        Nota: Conversions son a nivel video (asociadas al UTM), tal como pediste.
      </div>
    </form>
  </section>
</main>

<script>
  // -----------------------------
  // Utils
  // -----------------------------
  const nf = new Intl.NumberFormat('es-ES');
  const METRICS = ['views', 'likes', 'comments', 'reposts', 'conversions'];
  const METRIC_LABEL = {
    views: 'Views',
    likes: 'Likes',
    comments: 'Comments',
    reposts: 'Reposts',
    conversions: 'Conversions'
  };

  const PLATFORMS = ['Instagram', 'LinkedIn', 'YouTube', 'TikTok', 'Oktopost'];

  // Pesos del score compuesto (suman 1)
  const SCORE_WEIGHTS = {
    views: 0.40,
    likes: 0.20,
    comments: 0.15,
    reposts: 0.15,
    conversions: 0.10
  };

  function uid() {
    return 'v_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function clampNonNeg(n) {
    n = Number(n);
    return Number.isFinite(n) && n > 0 ? Math.floor(n) : 0;
  }

  function formatDateISO(iso) {
    if (!iso) return '—';
    const d = new Date(iso + 'T00:00:00');
    return new Intl.DateTimeFormat('es-ES', { year:'numeric', month:'2-digit', day:'2-digit' }).format(d);
  }

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // NUEVO: normaliza URL y bloquea esquemas peligrosos
  function normalizeUrl(raw) {
    let s = String(raw ?? '').trim();
    if (!s) return '';

    // si no tiene esquema, asumimos https://
    const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(s);
    if (!hasScheme) s = 'https://' + s.replace(/^\/\//, '');

    try {
      const u = new URL(s);
      if (u.protocol === 'http:' || u.protocol === 'https:') return u.href;
    } catch (e) {}
    return '';
  }

  // -----------------------------
  // Aggregation helpers (multi-platform)
  // -----------------------------
  function ensurePlatforms(video) {
    // Backward compat: if video has legacy top-level metrics, wrap into one platform.
    if (Array.isArray(video.platforms)) return video;

    const legacy = {
      platform: 'YouTube',
      url: '',
      views: Number(video.views) || 0,
      likes: Number(video.likes) || 0,
      comments: Number(video.comments) || 0,
      reposts: Number(video.reposts) || 0
    };

    return {
      id: video.id || uid(),
      title: video.title || '',
      channel: video.channel || '',
      date: video.date || '',
      hasUtm: !!video.hasUtm,
      conversions: Number(video.conversions) || 0,
      platforms: [legacy]
    };
  }

  // NUEVO: agregación filtrable por plataforma
  function aggregateVideoForPlatform(video, platformFilter = 'all') {
    const v = ensurePlatforms(video);
    const totals = {
      views: 0, likes: 0, comments: 0, reposts: 0,
      conversions: v.hasUtm ? (Number(v.conversions) || 0) : 0
    };

    const rows = v.platforms || [];
    for (const p of rows) {
      if (platformFilter && platformFilter !== 'all' && p.platform !== platformFilter) continue;
      totals.views += Number(p.views) || 0;
      totals.likes += Number(p.likes) || 0;
      totals.comments += Number(p.comments) || 0;
      totals.reposts += Number(p.reposts) || 0;
    }
    return totals;
  }

  // (compat: por si usas este nombre en otro lado)
  function aggregateVideo(video) {
    return aggregateVideoForPlatform(video, 'all');
  }

  function maximaAgg(videos, platformFilter = 'all') {
    const max = { views: 0, likes: 0, comments: 0, reposts: 0, conversions: 0 };
    for (const raw of videos) {
      const v = ensurePlatforms(raw);
      const a = aggregateVideoForPlatform(v, platformFilter);
      for (const m of METRICS) max[m] = Math.max(max[m], Number(a[m]) || 0);
    }
    return max;
  }

  // Normaliza por máximo (0..1). Si max=0 => 0.
  function norm(value, max) {
    if (!max || max <= 0) return 0;
    return (value || 0) / max;
  }

  // Score compuesto normalizado
  function computeScoreAgg(agg, max) {
    let score = 0;
    for (const m of METRICS) {
      score += norm(agg[m] || 0, max[m]) * SCORE_WEIGHTS[m];
    }
    return score; // 0..1
  }

  // -----------------------------
  // State + Elements
  // -----------------------------
  const state = {
    videos: [],
    metric: 'views',
    rankSort: 'score',
    platformFilter: 'all',
    editingId: null
  };

  const el = {
    pages: {
      dashboard: document.getElementById('dashboard'),
      form: document.getElementById('form'),
    },
    navButtons: Array.from(document.querySelectorAll('nav button')),
    totals: {
      videos: document.getElementById('totalVideos'),
      views: document.getElementById('totalViews'),
      likes: document.getElementById('totalLikes'),
      comments: document.getElementById('totalComments'),
      reposts: document.getElementById('totalReposts'),
      conversions: document.getElementById('totalConversions')
    },
    metricSelect: document.getElementById('metricSelect'),
    platformFilter: document.getElementById('platformFilter'),
    rankPlatformFilter: document.getElementById('rankPlatformFilter'),
    metricByVideoTitle: document.getElementById('metricByVideoTitle'),
    metricOverTimeTitle: document.getElementById('metricOverTimeTitle'),
    rankSort: document.getElementById('rankSort'),
    rankingList: document.getElementById('rankingList'),
    table: document.getElementById('videoTable'),

    // Form
    form: document.getElementById('videoForm'),
    videoId: document.getElementById('videoId'),
    title: document.getElementById('title'),
    channel: document.getElementById('channel'),
    date: document.getElementById('date'),
    hasUtm: document.getElementById('hasUtm'),
    conversionsRow: document.getElementById('conversionsRow'),
    conversions: document.getElementById('conversions'),
    platformRows: document.getElementById('platformRows'),
    addPlatformBtn: document.getElementById('addPlatformBtn'),
    saveBtn: document.getElementById('saveBtn'),
    cancelEditBtn: document.getElementById('cancelEditBtn')
  };

  let chartMetric = null;
  let chartTime = null;

  // -----------------------------
  // Persistence
  // -----------------------------
  const STORAGE_KEY = 'video_analytics_v1';

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        state.videos = parsed.map(ensurePlatforms);
      }
    } catch (e) {
      console.warn('No se pudo leer localStorage:', e);
    }
  }

  function persist() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.videos));
    } catch (e) {
      console.warn('No se pudo guardar en localStorage:', e);
    }
  }

  // -----------------------------
  // Navigation
  // -----------------------------
  function showPage(pageId) {
    Object.values(el.pages).forEach(p => p.classList.remove('active'));
    el.pages[pageId].classList.add('active');

    el.navButtons.forEach(b => b.classList.remove('active'));
    el.navButtons.find(b => b.dataset.page === pageId)?.classList.add('active');
  }

  // -----------------------------
  // Platform filters (dashboard)
  // -----------------------------
  function populatePlatformFilters() {
    const options = [
      { value: 'all', label: 'All platforms' },
      ...PLATFORMS.map(p => ({ value: p, label: p }))
    ];

    const html = options.map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join('');
    el.platformFilter.innerHTML = html;
    el.rankPlatformFilter.innerHTML = html;

    el.platformFilter.value = state.platformFilter;
    el.rankPlatformFilter.value = state.platformFilter;
  }

  function setPlatformFilter(value) {
    state.platformFilter = value || 'all';
    if (el.platformFilter.value !== state.platformFilter) el.platformFilter.value = state.platformFilter;
    if (el.rankPlatformFilter.value !== state.platformFilter) el.rankPlatformFilter.value = state.platformFilter;
    renderRanking();
    renderCharts();
  }

  // -----------------------------
  // Platform rows (form)
  // -----------------------------
  function platformRowTemplate(data = {}) {
    const rowId = 'p_' + Math.random().toString(16).slice(2);
    const platform = data.platform || 'Instagram';
    const views = Number.isFinite(Number(data.views)) ? Number(data.views) : 0;
    const likes = Number.isFinite(Number(data.likes)) ? Number(data.likes) : 0;
    const comments = Number.isFinite(Number(data.comments)) ? Number(data.comments) : 0;
    const reposts = Number.isFinite(Number(data.reposts)) ? Number(data.reposts) : 0;
    const url = data.url ? String(data.url) : '';

    return `
      <div class="platform-row" data-row="${rowId}">
        <div class="row">
          <div>
            <label>Platform</label>
            <select class="p-platform">
              ${PLATFORMS.map(p => `<option value="${p}" ${p===platform?'selected':''}>${p}</option>`).join('')}
            </select>
          </div>
          <div>
            <label>Views</label>
            <input class="p-views" type="number" min="0" step="1" value="${views}" />
          </div>
          <div>
            <label>Likes</label>
            <input class="p-likes" type="number" min="0" step="1" value="${likes}" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Comments</label>
            <input class="p-comments" type="number" min="0" step="1" value="${comments}" />
          </div>
          <div>
            <label>Reposts</label>
            <input class="p-reposts" type="number" min="0" step="1" value="${reposts}" />
          </div>
          <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
            <button class="btn btn-danger" type="button" data-remove="${rowId}">Remove</button>
          </div>
        </div>

        <!-- NUEVO: URL de publicación -->
        <div class="row one">
          <div>
            <label>Post URL</label>
            <input class="p-url" type="url" placeholder="https://..." value="${escapeHtml(url)}" />
          </div>
        </div>
      </div>
    `;
  }

  function addPlatformRow(data) {
    el.platformRows.insertAdjacentHTML('beforeend', platformRowTemplate(data));
    bindPlatformRemoveButtons();
  }

  function bindPlatformRemoveButtons() {
    el.platformRows.querySelectorAll('[data-remove]').forEach(btn => {
      if (btn.dataset.bound === '1') return;
      btn.dataset.bound = '1';
      btn.addEventListener('click', () => {
        const id = btn.dataset.remove;
        const row = el.platformRows.querySelector(`[data-row="${id}"]`);
        if (row) row.remove();
        // Ensure at least one row
        if (el.platformRows.children.length === 0) addPlatformRow();
      });
    });
  }

  function readPlatformsFromForm() {
    const rows = Array.from(el.platformRows.querySelectorAll('.platform-row'));
    const platforms = rows.map(r => ({
      platform: r.querySelector('.p-platform')?.value || 'Instagram',
      views: clampNonNeg(r.querySelector('.p-views')?.value),
      likes: clampNonNeg(r.querySelector('.p-likes')?.value),
      comments: clampNonNeg(r.querySelector('.p-comments')?.value),
      reposts: clampNonNeg(r.querySelector('.p-reposts')?.value),
      url: normalizeUrl(r.querySelector('.p-url')?.value),
    }));

    return platforms.length ? platforms : [{ platform: 'Instagram', url:'', views: 0, likes: 0, comments: 0, reposts: 0 }];
  }

  // -----------------------------
  // Form logic
  // -----------------------------
  function toggleUtmUI() {
    const enabled = el.hasUtm.checked;
    el.conversionsRow.style.display = enabled ? 'block' : 'none';
    if (!enabled) el.conversions.value = '0';
  }

  function resetForm() {
    state.editingId = null;
    el.form.reset();
    el.videoId.value = '';
    el.conversionsRow.style.display = 'none';
    el.saveBtn.textContent = 'Save';
    el.cancelEditBtn.style.display = 'none';

    // Reset platform rows
    el.platformRows.innerHTML = '';
    addPlatformRow({ platform: 'Instagram' });
  }

  function startEdit(id) {
    const v = state.videos.find(x => x.id === id);
    if (!v) return;

    state.editingId = id;
    el.videoId.value = v.id;
    el.title.value = v.title || '';
    el.channel.value = v.channel || '';
    el.date.value = v.date || '';

    el.hasUtm.checked = !!v.hasUtm;
    el.conversions.value = v.conversions ?? 0;
    toggleUtmUI();

    // Load platform rows
    el.platformRows.innerHTML = '';
    (v.platforms || []).forEach(p => addPlatformRow(p));
    if (!el.platformRows.children.length) addPlatformRow({ platform: 'Instagram' });

    el.saveBtn.textContent = 'Update';
    el.cancelEditBtn.style.display = 'inline-block';
    showPage('form');
  }

  function deleteVideo(id) {
    const v = state.videos.find(x => x.id === id);
    if (!v) return;

    const ok = confirm(`¿Borrar el video "${v.title}"?`);
    if (!ok) return;

    state.videos = state.videos.filter(x => x.id !== id);
    if (state.editingId === id) resetForm();
    persist();
    render();
  }

  function upsertFromForm(e) {
    e.preventDefault();

    const payload = {
      id: el.videoId.value || uid(),
      title: (el.title.value || '').trim(),
      channel: (el.channel.value || '').trim(),
      date: el.date.value,

      hasUtm: !!el.hasUtm.checked,
      conversions: el.hasUtm.checked ? clampNonNeg(el.conversions.value) : 0,

      platforms: readPlatformsFromForm()
    };

    if (!payload.title) {
      alert('El título es obligatorio.');
      return;
    }
    if (!payload.date) {
      alert('La fecha es obligatoria.');
      return;
    }

    const idx = state.videos.findIndex(v => v.id === payload.id);
    if (idx >= 0) {
      state.videos[idx] = payload;
    } else {
      state.videos.push(payload);
    }

    persist();
    resetForm();
    showPage('dashboard');
    render();
  }

  // -----------------------------
  // Rendering
  // -----------------------------
  function renderTotals() {
    el.totals.videos.textContent = nf.format(state.videos.length);

    const totals = state.videos.reduce((acc, v) => {
      const a = aggregateVideoForPlatform(v, 'all');
      acc.views += a.views;
      acc.likes += a.likes;
      acc.comments += a.comments;
      acc.reposts += a.reposts;
      acc.conversions += a.conversions;
      return acc;
    }, { views:0, likes:0, comments:0, reposts:0, conversions:0 });

    el.totals.views.textContent = nf.format(totals.views);
    el.totals.likes.textContent = nf.format(totals.likes);
    el.totals.comments.textContent = nf.format(totals.comments);
    el.totals.reposts.textContent = nf.format(totals.reposts);
    el.totals.conversions.textContent = nf.format(totals.conversions);
  }

  function renderTable() {
    if (state.videos.length === 0) {
      el.table.innerHTML = `<tr><td class="empty" colspan="11">Aún no hay videos. Ve a “Add / Edit” para cargar el primero.</td></tr>`;
      return;
    }

    el.table.innerHTML = state.videos
      .slice()
      .sort((a, b) => (b.date || '').localeCompare(a.date || ''))
      .map(raw => {
        const v = ensurePlatforms(raw);
        const a = aggregateVideoForPlatform(v, 'all');

        // NUEVO: muestra cada plataforma con métricas + link
        const platformsHtml = (v.platforms || []).length
          ? `<div class="platform-list">${
              v.platforms.map(p => {
                const postUrl = normalizeUrl(p.url);
                const linkHtml = postUrl
                  ? `<a class="platform-link" href="${escapeHtml(postUrl)}" target="_blank" rel="noopener">Link</a>`
                  : `<span class="muted" style="font-size:11px; font-weight:900;">—</span>`;

                return `
                  <div class="platform-item">
                    <span class="platform-pill">${escapeHtml(p.platform || '—')}</span>
                    ${linkHtml}
                    <div class="platform-metrics">
                      V:${nf.format(Number(p.views)||0)} · L:${nf.format(Number(p.likes)||0)} · C:${nf.format(Number(p.comments)||0)} · R:${nf.format(Number(p.reposts)||0)}
                    </div>
                  </div>
                `;
              }).join('')
            }</div>`
          : `<span class="muted">—</span>`;

        return `
          <tr>
            <td class="wrap"><strong>${escapeHtml(v.title)}</strong></td>
            <td class="wrap">${escapeHtml(v.channel || '—')}</td>
            <td>${formatDateISO(v.date)}</td>
            <td class="wrap">${platformsHtml}</td>
            <td>${nf.format(a.views)}</td>
            <td>${nf.format(a.likes)}</td>
            <td>${nf.format(a.comments)}</td>
            <td>${nf.format(a.reposts)}</td>
            <td>${v.hasUtm ? 'UTM' : '—'}</td>
            <td>${nf.format(a.conversions)}</td>
            <td>
              <div class="actions">
                <button class="btn" type="button" data-edit="${v.id}">Edit</button>
                <button class="btn btn-danger" type="button" data-del="${v.id}">Delete</button>
              </div>
            </td>
          </tr>
        `;
      })
      .join('');
  }

  function renderRanking() {
    if (state.videos.length === 0) {
      el.rankingList.innerHTML = `<div class="empty">Cargar videos para ver el ranking.</div>`;
      return;
    }

    const max = maximaAgg(state.videos, state.platformFilter);

    const scored = state.videos.map(raw => {
      const v = ensurePlatforms(raw);
      const agg = aggregateVideoForPlatform(v, state.platformFilter);
      const score = computeScoreAgg(agg, max);
      return { v, agg, score };
    });

    let ordered;
    if (state.rankSort === 'score') {
      ordered = scored.slice().sort((a, b) => b.score - a.score);
    } else {
      const k = state.rankSort;
      ordered = scored.slice().sort((a, b) => (b.agg[k] || 0) - (a.agg[k] || 0));
    }

    const bestScore = ordered[0]?.score || 1;

    el.rankingList.innerHTML = ordered.slice(0, 5).map((r, i) => {
      const v = r.v;
      const agg = r.agg;

      const parts = METRICS.map(m => {
        const normalized = norm(agg[m] || 0, max[m]);
        return { m, normalized, raw: agg[m] || 0 };
      });

      const scorePct = bestScore ? (r.score / bestScore) * 100 : 0;

      return `
        <div class="rank-item">
          <div class="rank-num">${i + 1}</div>
          <div>
            <div class="rank-title">
              <strong>${escapeHtml(v.title)}</strong>
              <span class="rank-sub">${escapeHtml(v.channel || '—')} · ${formatDateISO(v.date)} · ${state.platformFilter === 'all' ? 'All platforms' : escapeHtml(state.platformFilter)}</span>
            </div>

            <div class="rank-bar"><div style="width:${scorePct.toFixed(1)}%"></div></div>

            <div class="rank-breakdown">
              ${parts.map(p => `
                <div class="chip" title="Normalizado: ${(p.normalized*100).toFixed(0)}% · Peso: ${(SCORE_WEIGHTS[p.m]*100).toFixed(0)}%">
                  <div class="label">${METRIC_LABEL[p.m]}</div>
                  <div class="value">${nf.format(p.raw)}</div>
                </div>
              `).join('')}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;">${(r.score * 100).toFixed(1)}</div>
            <div class="muted" style="font-size:11px; font-weight:800;">score</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderCharts() {
    const metric = state.metric;
    const label = METRIC_LABEL[metric] || 'Metric';
    const pfLabel = state.platformFilter === 'all' ? 'All platforms' : state.platformFilter;

    el.metricByVideoTitle.textContent = `${label} by Video · ${pfLabel}`;
    el.metricOverTimeTitle.textContent = `${label} over Time · ${pfLabel}`;

    // Chart 1: Metric by video (filtered by platform)
    const videoLabels = state.videos.map(v => ensurePlatforms(v).title || '—');
    const videoData = state.videos.map(v => {
      const a = aggregateVideoForPlatform(v, state.platformFilter);
      return a[metric] || 0;
    });

    const horizontal = state.videos.length > 8;

    if (chartMetric) chartMetric.destroy();
    chartMetric = new Chart(document.getElementById('metricChart'), {
      type: 'bar',
      data: {
        labels: videoLabels.length ? videoLabels : ['—'],
        datasets: [{
          data: videoLabels.length ? videoData : [0],
          backgroundColor: '#ff355e',
          borderRadius: 8
        }]
      },
      options: {
        indexAxis: horizontal ? 'y' : 'x',
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `${label}: ${nf.format(ctx.parsed[horizontal ? 'x' : 'y'])}`
            }
          }
        },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } }
        }
      }
    });

    // Chart 2: Metric over time (filtered by platform, aggregated by date)
    const byDate = new Map();
    for (const v of state.videos) {
      const d = ensurePlatforms(v).date || '—';
      const a = aggregateVideoForPlatform(v, state.platformFilter);
      byDate.set(d, (byDate.get(d) || 0) + (Number(a[metric]) || 0));
    }

    const dates = Array.from(byDate.keys())
      .filter(d => d !== '—')
      .sort((a, b) => a.localeCompare(b));

    const timeLabels = dates.length ? dates.map(formatDateISO) : ['—'];
    const timeData = dates.length ? dates.map(d => byDate.get(d) || 0) : [0];

    if (chartTime) chartTime.destroy();
    chartTime = new Chart(document.getElementById('metricTimeChart'), {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: [{
          data: timeData,
          borderColor: '#ff355e',
          backgroundColor: 'rgba(255,53,94,0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: (ctx) => `${label}: ${nf.format(ctx.parsed.y)}` }
          }
        }
      }
    });
  }

  function render() {
    renderTotals();
    renderRanking();
    renderTable();
    renderCharts();
  }

  // -----------------------------
  // Event bindings
  // -----------------------------
  el.navButtons.forEach(btn => {
    btn.addEventListener('click', () => showPage(btn.dataset.page));
  });

  el.metricSelect.addEventListener('change', () => {
    state.metric = el.metricSelect.value;
    renderCharts();
    renderRanking();
  });

  el.platformFilter.addEventListener('change', () => setPlatformFilter(el.platformFilter.value));
  el.rankPlatformFilter.addEventListener('change', () => setPlatformFilter(el.rankPlatformFilter.value));

  el.rankSort.addEventListener('change', () => {
    state.rankSort = el.rankSort.value;
    renderRanking();
  });

  el.hasUtm.addEventListener('change', toggleUtmUI);

  el.addPlatformBtn.addEventListener('click', () => {
    addPlatformRow({ platform: 'Instagram' });
  });

  el.form.addEventListener('submit', upsertFromForm);

  el.cancelEditBtn.addEventListener('click', () => {
    resetForm();
    showPage('dashboard');
  });

  // NUEVO: Event delegation para que Delete/Edit siempre funcione
  el.table.addEventListener('click', (e) => {
    const editBtn = e.target.closest('[data-edit]');
    if (editBtn) startEdit(editBtn.dataset.edit);

    const delBtn = e.target.closest('[data-del]');
    if (delBtn) deleteVideo(delBtn.dataset.del);
  });

  // -----------------------------
  // Dev API (para "acceder por separado y usar por separado")
  // -----------------------------
  window.VideoAnalytics = {
    getVideos: () => state.videos.slice(),
    getVideo: (id) => state.videos.find(v => v.id === id) || null,
    getPlatforms: (id) => (state.videos.find(v => v.id === id)?.platforms || []).slice(),
    getPlatform: (id, platformName) => {
      const v = state.videos.find(v => v.id === id);
      if (!v) return null;
      return (v.platforms || []).find(p => p.platform === platformName) || null;
    },
    aggregate: (id, platformFilter = 'all') => {
      const v = state.videos.find(v => v.id === id);
      if (!v) return null;
      return aggregateVideoForPlatform(v, platformFilter);
    }
  };

  // -----------------------------
  // Init
  // -----------------------------
  load();
  state.metric = el.metricSelect.value;
  state.rankSort = el.rankSort.value;

  populatePlatformFilters();
  setPlatformFilter('all');

  resetForm();
  render();
</script>
</body>
</html>
